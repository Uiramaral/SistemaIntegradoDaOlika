# âœ… PARTE 8 COMPLETA - PERMISSÃ•ES (RBAC)

## ğŸ“ ARQUIVOS CRIADOS/ATUALIZADOS

### Migration:
- âœ… `database/migrations/2025_01_01_000000_add_role_to_users.php`
  - Adiciona coluna `role` na tabela `users`
  - Default: 'leitor'
  - Indexado para performance

### Middleware:
- âœ… `app/Http/Middleware/EnsureRole.php`
  - Valida role do usuÃ¡rio
  - Permite mÃºltiplas roles via parÃ¢metros

### Policies:
- âœ… `app/Policies/PedidoPolicy.php`
  - viewAny, view, create, update, delete, bulk
  - Roles: admin, gestor, atendimento, producao, entrega, leitor

- âœ… `app/Policies/ConsignacaoPolicy.php`
  - viewAny, view, create, update, delete
  - Roles: admin, gestor, leitor

- âœ… `app/Policies/CupomPolicy.php`
  - viewAny, view, create, update, delete
  - Roles: admin, gestor, leitor

### Providers:
- âœ… `app/Providers/AuthServiceProvider.php` (atualizado)
  - Registra policies
  - Define gates (view-reports, manage-catalog, manage-users)

- âœ… `app/Providers/AppServiceProvider.php` (atualizado)
  - Helper Blade `@role`

---

## ğŸ¯ PERMISSÃ•ES POR ROLE

### admin
- âœ… Tudo (pedidos, consignaÃ§Ãµes, cupons, relatÃ³rios, usuÃ¡rios)

### gestor
- âœ… Tudo exceto gerenciar usuÃ¡rios
- âœ… Visualiza e gerencia relatÃ³rios

### atendimento
- âœ… Criar e editar pedidos
- âœ… Ver pedidos e consignaÃ§Ãµes
- âŒ NÃ£o pode criar consignaÃ§Ãµes
- âŒ NÃ£o pode ver relatÃ³rios

### producao
- âœ… Ver e editar pedidos
- âœ… AÃ§Ãµes em massa (bulk)
- âœ… Ver consignaÃ§Ãµes
- âŒ NÃ£o pode criar pedidos/consignaÃ§Ãµes
- âŒ NÃ£o pode ver relatÃ³rios

### entrega
- âœ… Ver pedidos
- âœ… Ver consignaÃ§Ãµes
- âŒ NÃ£o pode editar
- âŒ NÃ£o pode ver relatÃ³rios

### leitor
- âœ… Ver pedidos
- âœ… Ver consignaÃ§Ãµes
- âœ… Ver cupons
- âŒ NÃ£o pode criar/editar/remover
- âŒ NÃ£o pode ver relatÃ³rios

---

## ğŸ“‹ PRÃ“XIMOS PASSOS

### 1. Registrar middleware no Kernel:
```php
// FILE: app/Http/Kernel.php
// array $routeMiddleware ou $middlewareAliases

'role' => \App\Http\Middleware\EnsureRole::class,
```

### 2. Atualizar rotas com middleware:
```php
// Revisar routes/web.php e adicionar:
Route::middleware(['auth','role:admin,gestor'])->group(function(){
  Route::get('relatorios', [ReportsController::class,'index'])->name('relatorios.index');
});
```

### 3. Proteger rotas bulk:
```php
Route::post('pedidos/bulk', [PedidosBulkController::class,'update'])
  ->name('pedidos.bulk')
  ->middleware('can:bulk,App\\Models\\Pedido');
```

### 4. Atualizar views com @can:
- âœ… Adicionar `@can` em botÃµes de criar/editar/remover
- âœ… Ver exemplos abaixo

---

## ğŸ¨ EXEMPLOS DE USO NAS VIEWS

### Dashboard (page-actions):
```blade
@section('page-actions')
  @can('create', App\Models\Pedido::class)
    <a href="{{ route('pedidos.create') }}" class="btn-primary">Novo Pedido</a>
  @endcan

  @can('view-reports')
    <a href="{{ route('relatorios.index') }}" class="pill">ğŸ“Š RelatÃ³rios</a>
  @endcan

  @can('viewAny', App\Models\Consignacao::class)
    <a href="{{ route('consignacoes.index') }}" class="pill">ConsignaÃ§Ãµes</a>
  @endcan
@endsection
```

### Pedidos (aÃ§Ãµes por linha):
```blade
<td class="text-right">
  <a class="pill" href="{{ route('pedidos.show',$p) }}">Ver</a>
  
  @can('update',$p)
    <a class="pill" href="{{ route('pedidos.edit',$p) }}">Editar</a>
  @endcan
  
  @can('delete',$p)
    <form method="POST" action="{{ route('pedidos.destroy',$p) }}" class="inline">
      @csrf @method('DELETE')
      <button class="pill">Remover</button>
    </form>
  @endcan
</td>
```

### Bulk actions:
```blade
@can('bulk', App\Models\Pedido::class)
  {{-- renderizar barra de bulk --}}
@endcan
```

### Helper @role:
```blade
@role('admin','gestor')
  <a class="pill" href="{{ route('users.index') }}">UsuÃ¡rios</a>
@endrole
```

---

## ğŸš€ IMPLEMENTAÃ‡ÃƒO

### 1. Rodar migration:
```bash
php artisan migrate
```

### 2. Atualizar usuÃ¡rios existentes:
```sql
UPDATE users SET role = 'admin' WHERE email = 'seu@email.com';
```

### 3. Limpar cache:
```bash
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear
php artisan optimize:clear
```

### 4. Registrar middleware (se ainda nÃ£o foi):
```bash
php artisan make:middleware EnsureRole
```
(JÃ¡ criado manualmente, mas pode revisar)

### 5. Proteger rotas crÃ­ticas:
Revisar `routes/web.php` e adicionar middleware:
- RelatÃ³rios: `middleware('can:view-reports')`
- Bulk actions: `middleware('can:bulk,App\\Models\\Pedido')`

---

## ğŸ”’ SEGURANÃ‡A

### Defense in Depth:
1. âœ… **UI**: Esconde botÃµes/menus com `@can`
2. âœ… **Backend**: Valida com policies/gates
3. âœ… **Middleware**: Bloqueia acesso nÃ£o autorizado
4. âœ… **Database**: Logs de auditoria (implementar depois)

### Boas PrÃ¡ticas:
- âœ… Nunca confiar apenas na UI
- âœ… Sempre validar no backend
- âœ… Usar policies para lÃ³gica complexa
- âœ… Usar gates para aÃ§Ãµes gerais
- âœ… Documentar permissÃµes por role

---

## ğŸ“Š MATRIZ DE PERMISSÃ•ES

| AÃ§Ã£o | admin | gestor | atendimento | producao | entrega | leitor |
|------|-------|--------|-------------|----------|---------|--------|
| Ver Pedidos | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| Criar Pedidos | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ |
| Editar Pedidos | âœ… | âœ… | âœ… | âœ… | âŒ | âŒ |
| Remover Pedidos | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| Bulk Actions | âœ… | âœ… | âŒ | âœ… | âŒ | âŒ |
| Ver ConsignaÃ§Ãµes | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| Criar ConsignaÃ§Ãµes | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| Editar ConsignaÃ§Ãµes | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| Ver RelatÃ³rios | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| Gerenciar UsuÃ¡rios | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ |

---

## âœ… CHECKLIST FINAL

- [ ] Rodar migration
- [ ] Atualizar roles dos usuÃ¡rios existentes
- [ ] Registrar middleware no Kernel
- [ ] Proteger rotas crÃ­ticas
- [ ] Atualizar views com @can
- [ ] Testar com diferentes roles
- [ ] Implementar logs de auditoria (opcional)
- [ ] Documentar permissÃµes para equipe

**Arquivos prontos! Execute a migration e teste.** ğŸš€
