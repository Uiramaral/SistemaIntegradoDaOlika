# ‚úÖ PDV CONTROLLER ATUALIZADO - FUNCIONALIDADES ADICIONADAS

## üìã RESUMO
Controller PDV atualizado com fun√ß√µes para c√°lculo de frete din√¢mico, gera√ß√£o de PIX local e suporte a item avulso e fiado.

## üìÅ FUN√á√ïES ADICIONADAS

### 1. digits($s)
**Fun√ß√£o:** Remove caracteres n√£o num√©ricos de uma string
```php
private function digits($s)
{
    return preg_replace('/\D+/', '', (string)$s);
}
```

### 2. computeDeliveryFee(?string $cep, float $subtotal): float
**Fun√ß√£o:** Calcula frete baseado em delivery_rules ou delivery_fees
**L√≥gica:**
- Remove caracteres n√£o num√©ricos do CEP
- Verifica se CEP tem 8 d√≠gitos
- Busca regra em `delivery_rules` ou `delivery_fees`
- Verifica valor m√≠nimo para frete gr√°tis
- Retorna valor do frete

**Uso:**
```php
$deliveryFee = $this->computeDeliveryFee($cep, $subtotal);
```

### 3. pixCRC16($payload)
**Fun√ß√£o:** Calcula CRC16 para c√≥digo PIX
**Uso:** Necess√°rio para gerar c√≥digo PIX v√°lido

### 4. emv(string $id, string $value)
**Fun√ß√£o:** Cria campo EMV para c√≥digo PIX
**Formato:** ID + tamanho (2 d√≠gitos) + valor

### 5. buildPixPayload(array $pix)
**Fun√ß√£o:** Constr√≥i payload completo do c√≥digo PIX
**Par√¢metros esperados:**
```php
[
    'chave'  => 'Chave PIX',         // CPF/CNPJ/Email/Chave aleat√≥ria
    'nome'   => 'Nome Recebedor',    // At√© 25 caracteres
    'cidade' => 'Cidade',            // At√© 15 caracteres
    'txid'   => 'ID transa√ß√£o',      // At√© 25 caracteres
    'valor'  => '123.45',            // Com 2 casas decimais
    'info'   => 'Info adicional'     // Opcional, at√© 50 caracteres
]
```

**Retorno:** String com c√≥digo PIX completo (copia e cola)

## üîß AJUSTES NECESS√ÅRIOS NO M√âTODO store()

O m√©todo `store()` precisa ser atualizado para suportar:

### 1. Calcular frete usando computeDeliveryFee
```php
$delivery = $data['delivery_type']==='delivery'
    ? $this->computeDeliveryFee($data['address']['cep'] ?? null, $subtotal)
    : 0.00;
```

### 2. Gerar PIX quando payment_method = 'pix'
```php
if($data['payment_method']==='pix'){
    $pixKey   = config('app.pix_key', 'SUA-CHAVE-PIX-AQUI');
    $nome     = config('app.pix_name', 'OLIKA COZINHA');
    $cidade   = config('app.pix_city', 'SALVADOR');

    $payload = $this->buildPixPayload([
        'chave'  => $pixKey,
        'nome'   => $nome,
        'cidade' => $cidade,
        'txid'   => 'PDV'.str_pad((string)$order->id, 10, '0', STR_PAD_LEFT),
        'valor'  => number_format($final, 2, '.', ''),
        'info'   => 'Pedido '.$order->order_number
    ]);

    $order->pix_copy_paste = $payload;
    $order->pix_expires_at = now()->addMinutes(30);
    $order->save();
}
```

### 3. Lan√ßar d√©bito quando Fiado
```php
if($data['payment_method']==='fiado'){
    DB::table('customer_debts')->insert([
        'customer_id'  => $data['customer_id'],
        'order_id'     => $order->id,
        'amount'       => $final,
        'type'         => 'debit',
        'status'       => 'open',
        'description'  => 'Venda fiado PDV #'.$order->order_number,
        'created_at'   => now(),
        'updated_at'   => now(),
    ]);
}
```

### 4. Suporte a item avulso em order_items
```php
foreach($data['items'] as $i){
    OrderItem::create([
        'order_id'    => $order->id,
        'product_id'  => $i['product_id'],      // nullable para avulsos
        'custom_name' => $i['custom'] ? $i['name'] : null,  // NOVO
        'quantity'    => $i['qty'],
        'unit_price'  => $i['price'],
        'total_price' => $i['price'] * $i['qty'],
    ]);
}
```

## üîå NOVA ROTA NECESS√ÅRIA

Adicionar em `routes/web.php` ou `routes/api.php`:

```php
Route::get('/api/calc-frete', function(\Illuminate\Http\Request $r){
    $pdv = app(\App\Http\Controllers\Dashboard\PDVController::class);
    $fee = $pdv->computeDeliveryFee($r->get('cep'), (float)$r->get('subtotal',0));
    return response()->json(['fee'=>$fee]);
});
```

## üìù ATUALIZAR BLADE

A blade `pdv.blade.php` precisa da fun√ß√£o `recalc()` atualizada para calcular frete em tempo real:

```javascript
async function recalc(){
  state.totals.sub = state.items.reduce((s,i)=> s + (i.price*i.qty), 0);

  // calcula frete no backend quando for entrega
  if (document.getElementById('deliveryType').value === 'delivery') {
    const cep = document.getElementById('cep').value || '';
    try{
      const r = await fetch('/api/calc-frete?cep='+encodeURIComponent(cep)+'&subtotal='+state.totals.sub);
      const j = await r.json();
      state.totals.delivery = j.fee || 0;
    }catch(e){ state.totals.delivery = 0; }
  } else {
    state.totals.delivery = 0;
  }

  state.totals.total = Math.max(0, state.totals.sub - state.totals.discount + state.totals.delivery);
  document.getElementById('subtotal').innerText = fmt(state.totals.sub);
  document.getElementById('discount').innerText = fmt(state.totals.discount);
  document.getElementById('deliveryFee').innerText = fmt(state.totals.delivery);
  document.getElementById('grandTotal').innerText = fmt(state.totals.total);
}

// Recalcula ao mudar quantidade, CEP ou tipo de entrega
['qty','cep','deliveryType'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('change', recalc);
});
```

## ‚öôÔ∏è CONFIGURA√á√ÉO

Adicionar em `.env`:

```env
PIX_KEY=00020126360014BR.GOV.BCB.PIX0114+5538999999999010400005303986540510.005802BR5920OLIKA COZINHA6009SALVADOR62070503***
PIX_NAME=OLIKA COZINHA
PIX_CITY=SALVADOR
```

Ou em `config/app.php`:

```php
'pix_key' => env('PIX_KEY', 'SUA-CHAVE-PIX-AQUI'),
'pix_name' => env('PIX_NAME', 'OLIKA COZINHA'),
'pix_city' => env('PIX_CITY', 'SALVADOR'),
```

## ‚úÖ STATUS

- ‚úÖ Fun√ß√µes adicionadas ao controller
- ‚ö†Ô∏è M√©todo store() precisa ser atualizado
- ‚ö†Ô∏è Rota para c√°lculo de frete precisa ser adicionada
- ‚ö†Ô∏è Blade precisa da fun√ß√£o recalc() atualizada
- ‚ö†Ô∏è Configura√ß√£o de PIX precisa ser adicionada

